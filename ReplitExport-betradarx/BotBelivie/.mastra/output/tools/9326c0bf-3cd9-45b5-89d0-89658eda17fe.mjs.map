{"version":3,"file":"9326c0bf-3cd9-45b5-89d0-89658eda17fe.mjs","sources":["../../../src/mastra/tools/verifyGoalOutcomes.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport pg from \"pg\";\nimport axios from \"axios\";\n\nexport const verifyGoalOutcomes = createTool({\n  id: \"verify-goal-outcomes\",\n  description: \"Checks recent alerts and updates goal_happened status by comparing goal totals before/after alerts\",\n  \n  inputSchema: z.object({}),\n  \n  outputSchema: z.object({\n    checked: z.number(),\n    updated: z.number(),\n    success: z.boolean(),\n    error: z.string().optional(),\n  }),\n  \n  execute: async ({ mastra }) => {\n    const logger = mastra?.getLogger();\n    logger?.info(\"üîß [verifyGoalOutcomes] Starting execution\");\n    \n    const connectionString = process.env.DATABASE_URL;\n    const apiKey = process.env.API_FOOTBALL_KEY;\n    \n    if (!connectionString || !apiKey) {\n      logger?.error(\"‚ùå [verifyGoalOutcomes] Missing configuration\", {\n        hasDb: !!connectionString,\n        hasApiKey: !!apiKey,\n      });\n      return {\n        checked: 0,\n        updated: 0,\n        success: false,\n        error: \"Missing DATABASE_URL or API_FOOTBALL_KEY\",\n      };\n    }\n    \n    const client = new pg.Client({ connectionString });\n    \n    try {\n      await client.connect();\n      \n      const query = `\n        SELECT id, fixture_id, minute, goals_at_alert, created_at\n        FROM football_alerts\n        WHERE goal_happened IS NULL\n          AND created_at < NOW() - INTERVAL '10 minutes'\n        ORDER BY created_at ASC\n        LIMIT 50\n      `;\n      \n      logger?.info(\"üîç [verifyGoalOutcomes] Querying unverified alerts older than 10 minutes\");\n      const result = await client.query(query);\n      const alerts = result.rows;\n      \n      logger?.info(\"üìã [verifyGoalOutcomes] Found unverified alerts\", {\n        count: alerts.length,\n      });\n      \n      let updated = 0;\n      \n      for (const alert of alerts) {\n        try {\n          const url = `https://v3.football.api-sports.io/fixtures?id=${alert.fixture_id}`;\n          logger?.info(\"üì° [verifyGoalOutcomes] Fetching fixture data\", {\n            alertId: alert.id,\n            fixtureId: alert.fixture_id,\n          });\n          \n          const response = await axios.get(url, {\n            headers: { \"x-apisports-key\": apiKey },\n            timeout: 10000,\n          });\n          \n          if (response.data.response && response.data.response.length > 0) {\n            const fixture = response.data.response[0];\n            const goals = fixture.goals;\n            \n            const homeGoals = goals?.home || 0;\n            const awayGoals = goals?.away || 0;\n            const totalGoalsNow = homeGoals + awayGoals;\n            const goalsAtAlert = alert.goals_at_alert || 0;\n            \n            const goalHappened = totalGoalsNow > goalsAtAlert;\n            \n            const updateQuery = `\n              UPDATE football_alerts\n              SET goal_happened = $1\n              WHERE id = $2\n            `;\n            \n            await client.query(updateQuery, [goalHappened, alert.id]);\n            updated++;\n            \n            logger?.info(\"‚úÖ [verifyGoalOutcomes] Updated alert\", {\n              alertId: alert.id,\n              fixtureId: alert.fixture_id,\n              goalsAtAlert,\n              totalGoalsNow,\n              goalHappened,\n              goalIncrease: totalGoalsNow - goalsAtAlert,\n            });\n          }\n        } catch (error: any) {\n          logger?.warn(\"‚ö†Ô∏è [verifyGoalOutcomes] Error checking fixture\", {\n            alertId: alert.id,\n            fixtureId: alert.fixture_id,\n            error: error.message,\n          });\n        }\n        \n        await new Promise((resolve) => setTimeout(resolve, 500));\n      }\n      \n      logger?.info(\"‚úÖ [verifyGoalOutcomes] Completed verification\", {\n        checked: alerts.length,\n        updated,\n      });\n      \n      return {\n        checked: alerts.length,\n        updated,\n        success: true,\n      };\n    } catch (error: any) {\n      logger?.error(\"‚ùå [verifyGoalOutcomes] Error verifying outcomes\", {\n        error: error.message,\n      });\n      \n      return {\n        checked: 0,\n        updated: 0,\n        success: false,\n        error: error.message || \"Unknown error occurred\",\n      };\n    } finally {\n      await client.end();\n    }\n  },\n});\n"],"names":[],"mappings":"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"}