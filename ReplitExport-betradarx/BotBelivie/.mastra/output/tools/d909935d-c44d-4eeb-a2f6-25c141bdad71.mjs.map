{"version":3,"file":"d909935d-c44d-4eeb-a2f6-25c141bdad71.mjs","sources":["../../../src/mastra/tools/performDailyAnalysis.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport pg from \"pg\";\n\nexport const performDailyAnalysis = createTool({\n  id: \"perform-daily-analysis\",\n  description: \"Analyzes alert accuracy from the past 24 hours and calculates new threshold recommendations\",\n  \n  inputSchema: z.object({}),\n  \n  outputSchema: z.object({\n    matchesMonitored: z.number(),\n    alertsSent: z.number(),\n    goalsConfirmed: z.number(),\n    accuracy: z.number(),\n    currentThresholds: z.object({\n      thresholdTotal: z.number(),\n      thresholdDiff: z.number(),\n      escanteios10min: z.number(),\n    }),\n    recommendedThresholds: z.object({\n      thresholdTotal: z.number(),\n      thresholdDiff: z.number(),\n      escanteios10min: z.number(),\n    }),\n    success: z.boolean(),\n    error: z.string().optional(),\n  }),\n  \n  execute: async ({ mastra }) => {\n    const logger = mastra?.getLogger();\n    logger?.info(\"üîß [performDailyAnalysis] Starting daily analysis\");\n    \n    const connectionString = process.env.DATABASE_URL;\n    if (!connectionString) {\n      logger?.error(\"‚ùå [performDailyAnalysis] DATABASE_URL not found\");\n      return {\n        matchesMonitored: 0,\n        alertsSent: 0,\n        goalsConfirmed: 0,\n        accuracy: 0,\n        currentThresholds: { thresholdTotal: 70, thresholdDiff: 15, escanteios10min: 3 },\n        recommendedThresholds: { thresholdTotal: 70, thresholdDiff: 15, escanteios10min: 3 },\n        success: false,\n        error: \"DATABASE_URL not configured\",\n      };\n    }\n    \n    const client = new pg.Client({ connectionString });\n    \n    try {\n      await client.connect();\n      \n      const statsQuery = `\n        SELECT \n          COUNT(*) as total_alerts,\n          COUNT(CASE WHEN goal_happened = true THEN 1 END) as goals_confirmed,\n          COUNT(DISTINCT fixture_id) as unique_matches\n        FROM football_alerts\n        WHERE created_at > NOW() - INTERVAL '24 hours'\n          AND goal_happened IS NOT NULL\n      `;\n      \n      logger?.info(\"üìä [performDailyAnalysis] Calculating statistics\");\n      const statsResult = await client.query(statsQuery);\n      const stats = statsResult.rows[0];\n      \n      const alertsSent = parseInt(stats.total_alerts, 10) || 0;\n      const goalsConfirmed = parseInt(stats.goals_confirmed, 10) || 0;\n      const matchesMonitored = parseInt(stats.unique_matches, 10) || 0;\n      const accuracy = alertsSent > 0 ? (goalsConfirmed / alertsSent) * 100 : 0;\n      \n      logger?.info(\"üìà [performDailyAnalysis] Statistics calculated\", {\n        matchesMonitored,\n        alertsSent,\n        goalsConfirmed,\n        accuracy: accuracy.toFixed(2) + \"%\",\n      });\n      \n      const thresholdsQuery = `\n        SELECT threshold_total, threshold_diff, escanteios_10min\n        FROM football_thresholds\n        WHERE id = 1\n      `;\n      \n      const thresholdsResult = await client.query(thresholdsQuery);\n      const currentThresholds = thresholdsResult.rows[0];\n      \n      let thresholdTotal = parseFloat(currentThresholds.threshold_total);\n      let thresholdDiff = parseFloat(currentThresholds.threshold_diff);\n      let escanteios10min = parseInt(currentThresholds.escanteios_10min, 10);\n      \n      logger?.info(\"üéØ [performDailyAnalysis] Current thresholds\", {\n        thresholdTotal,\n        thresholdDiff,\n        escanteios10min,\n      });\n      \n      let adjustmentFactor = 0;\n      if (accuracy > 85) {\n        adjustmentFactor = -0.05;\n        logger?.info(\"üìâ [performDailyAnalysis] High accuracy - decreasing thresholds\");\n      } else if (accuracy < 50 && alertsSent >= 3) {\n        adjustmentFactor = 0.05;\n        logger?.info(\"üìà [performDailyAnalysis] Low accuracy - increasing thresholds\");\n      } else {\n        logger?.info(\"‚û°Ô∏è [performDailyAnalysis] Accuracy within range - no adjustment\");\n      }\n      \n      let newThresholdTotal = thresholdTotal * (1 + adjustmentFactor);\n      let newThresholdDiff = thresholdDiff * (1 + adjustmentFactor);\n      let newEscanteios = escanteios10min;\n      \n      newThresholdTotal = Math.max(50, Math.min(120, newThresholdTotal));\n      newThresholdDiff = Math.max(10, Math.min(30, newThresholdDiff));\n      newEscanteios = Math.max(2, Math.min(6, newEscanteios));\n      \n      logger?.info(\"üéØ [performDailyAnalysis] Recommended thresholds\", {\n        newThresholdTotal,\n        newThresholdDiff,\n        newEscanteios,\n      });\n      \n      if (adjustmentFactor !== 0) {\n        const updateQuery = `\n          UPDATE football_thresholds\n          SET threshold_total = $1,\n              threshold_diff = $2,\n              escanteios_10min = $3,\n              last_updated = NOW()\n          WHERE id = 1\n        `;\n        \n        await client.query(updateQuery, [\n          newThresholdTotal,\n          newThresholdDiff,\n          newEscanteios,\n        ]);\n        \n        logger?.info(\"‚úÖ [performDailyAnalysis] Thresholds updated in database\");\n      }\n      \n      return {\n        matchesMonitored,\n        alertsSent,\n        goalsConfirmed,\n        accuracy: Math.round(accuracy * 100) / 100,\n        currentThresholds: {\n          thresholdTotal,\n          thresholdDiff,\n          escanteios10min,\n        },\n        recommendedThresholds: {\n          thresholdTotal: Math.round(newThresholdTotal * 100) / 100,\n          thresholdDiff: Math.round(newThresholdDiff * 100) / 100,\n          escanteios10min: newEscanteios,\n        },\n        success: true,\n      };\n    } catch (error: any) {\n      logger?.error(\"‚ùå [performDailyAnalysis] Error performing analysis\", {\n        error: error.message,\n      });\n      \n      return {\n        matchesMonitored: 0,\n        alertsSent: 0,\n        goalsConfirmed: 0,\n        accuracy: 0,\n        currentThresholds: { thresholdTotal: 70, thresholdDiff: 15, escanteios10min: 3 },\n        recommendedThresholds: { thresholdTotal: 70, thresholdDiff: 15, escanteios10min: 3 },\n        success: false,\n        error: error.message || \"Unknown error occurred\",\n      };\n    } finally {\n      await client.end();\n    }\n  },\n});\n"],"names":[],"mappings":"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"}